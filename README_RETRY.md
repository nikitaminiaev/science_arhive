# Скрипт для повторной обработки PDF файлов с ошибками

## Описание

`retry_failed_pdfs.py` - это утилита для повторной обработки PDF файлов, которые вызвали ошибки при первоначальной индексации. Скрипт читает файл с ошибками (обычно `pdf_error.txt`) и пытается повторно обработать проблемные PDF файлы.

## Установка и подготовка

1. Убедитесь, что у вас установлены все зависимости из `requirements.txt`
2. Убедитесь, что у вас есть файл с ошибками (обычно `pdf_error.txt`)
3. Убедитесь, что база данных существует и доступна

## Использование

### Базовое использование

```bash
python retry_failed_pdfs.py pdf_error.txt
```

### Расширенные параметры

```bash
python retry_failed_pdfs.py pdf_error.txt \
    --db /path/to/your/archive.db \
    --root-dir /path/to/your/archives \
    --output retry_errors.txt \
    --batch-size 20
```

### Параметры командной строки

- `error_file` (обязательный): Путь к файлу с ошибками
- `--db`: Путь к базе данных SQLite (по умолчанию: `archive.db`)
- `--root-dir`: Корневая директория архивов (автоматически определяется из путей в файле ошибок)
- `--output`: Файл для записи новых ошибок (по умолчанию: `retry_errors.txt`)
- `--batch-size`: Размер батча для вывода прогресса (по умолчанию: 10)

## Формат файла с ошибками

Скрипт ожидает файл с ошибками в следующем формате:

```
zip_path: /path/to/archive.zip
pdf_filename: document.pdf
error: Error message

zip_path: /path/to/another/archive.zip
pdf_filename: another_document.pdf
error: Another error message
```

## Примеры использования

### Простая повторная обработка

```bash
python retry_failed_pdfs.py pdf_error.txt
```

### Обработка с указанием базы данных и корневой директории

```bash
python retry_failed_pdfs.py pdf_error.txt \
    --db /media/ssd/archive.db \
    --root-dir "/media/nikita/Tom 12Tb 01/Никита/arch sin"
```

### Обработка с увеличенным размером батча для больших файлов

```bash
python retry_failed_pdfs.py pdf_error.txt \
    --batch-size 50 \
    --output failed_again.txt
```

## Что делает скрипт

1. **Парсинг файла ошибок**: Читает и анализирует файл с ошибками
2. **Определение корневой директории**: Автоматически определяет корневую директорию из путей в файле ошибок
3. **Повторная обработка**: Пытается повторно извлечь текст из каждого проблемного PDF файла
4. **Сохранение в базу данных**: Успешно обработанные файлы сохраняются в базу данных
5. **Отчет о результатах**: Выводит статистику успешных и неудачных обработок
6. **Запись новых ошибок**: Файлы, которые не удалось обработать повторно, записываются в файл новых ошибок

## Особенности

- **Проверка дубликатов**: Скрипт проверяет, не существует ли уже файл в базе данных перед обработкой
- **Очистка данных**: Применяется та же логика очистки UTF-8 символов, что и в основном скрипте
- **Прогресс обработки**: Показывает прогресс обработки с настраиваемым размером батча
- **Обработка ошибок**: Корректно обрабатывает ошибки и записывает их в отдельный файл

## Результаты

После завершения работы скрипт выводит:
- Количество успешно обработанных файлов
- Количество файлов, которые не удалось обработать
- Процент успеха
- Путь к файлу с новыми ошибками (если есть неудачные попытки)

## Устранение неполадок

### Ошибка "ZIP архив не найден"
- Проверьте, что пути в файле ошибок корректны
- Убедитесь, что диски/устройства хранения подключены

### Ошибка подключения к базе данных
- Проверьте путь к базе данных
- Убедитесь, что у вас есть права на запись в директорию базы данных

### Проблемы с кодировкой
- Скрипт использует ту же логику очистки UTF-8, что и основной скрипт
- Если проблемы с кодировкой persist, проверьте исходные PDF файлы 